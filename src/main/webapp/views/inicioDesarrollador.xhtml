<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xml:lang="es" lang="es"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Listado de Profesionales</title>
        <h:outputStylesheet library="css" name="diseñoDesarrollador.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
    </h:head>
    <body>
        <div class="sidebar">
            <div class="profile">
                <h3>Sistema Profesionales</h3>
            </div>
            <a href="inicioSesionUniversidad.xhtml">Universidades Perfil</a>
            <a href="perfilDesarrollador.xhtml">Administradores Perfil</a>
            <a href="inicioDesarrollador.xhtml">Profesionales Perfil</a>
            <a href="plan de estudio.xhtml">Plan de Estado</a>
            <a href="sobre nosotros.xhtml">Sobre Nosotros</a>
            <a href="principal inicio.xhtml">Paguina Principal</a>
            <a href="test.xhtml">Test</a>
            <a href="universidades.xhtml">Universidades</a>
            <a href="profesionales.xhtml">Profesionales</a>
            <a href="servicio.xhtml">Servicios</a>
            <h:form>
                <h:commandLink value="Cerrar Sesión" action="#{login.cerrarSesion}" onclick="return confirm('¿Desea Cerrar Sesion?')" />
            </h:form>
        </div>

        <div class="content">
            <div class="header">
                <h1>Listado de Profesionales</h1>
                <div>
                    <button class="btn btn-primary" onclick="openModal()">Agregar Profesional</button>
                </div>
            </div>

            <div class="profile-container">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Filtrar por nombre, especialidad..." />
                    <button class="btn btn-primary" onclick="buscarProfesionales()">Buscar</button>
                </div>

                <table border="1"  id="t-all" class="jsf-data-table display nowrap" width="100%"  >
                    <thead>
                        <tr>
                            <td style="display: none;"></td>
                            <th>Nombres</th>
                            <th>Apellido</th>
                            <td style="display: none;"></td>
                            <th>Especialidad</th>
                            <th>Correo Electrónico</th>
                            <th>Nombre de Usuario</th>
                            <th>Edad</th>
                            <td style="display: none;"></td>
                            <th>Documento</th>
                            <th>Contraseña</th>
                            <td style="display: none;"></td>
                            <th>Rol</th>
                            <th>Acciones</th>

                        </tr>
                    </thead>
                    <tbody>
                        <ui:repeat value="#{controllerDeUsuarios.listarUsuariosProfesionales()}"  var="user">
                            <tr>
                                <td style="display: none;">#{user.id}</td>
                                <td>#{user.nombres }</td>
                                <td>#{user.primerApellido}</td>
                                <td style="display: none;">#{user.segundoApellido}</td>
                                <td>#{user.especialidadId.nombre}</td>
                                <td>#{user.correoElectronico}</td>
                                <td>#{user.nombreUsuario}</td>
                                <td>#{user.edad}</td>
                                <td style="display: none;">#{user.tipoDocumentoId.id}</td>
                                <td>#{user.numeroDocumento}</td>
                                <td>#{user.contraseña}</td>
                                <td style="display: none;">#{user.fechaRegistro}</td>
                                <td>#{user.rolId.nombre}</td>

                                <td>
                                    <h:form id="formTabla">
                                        <h:commandButton value="Editar"  action="#{controllerDeUsuarios.editarUsuarioUno(user)}" >
                                            <f:ajax execute="@this" render="modalForm" onevent="abrirModalSiCompletado" /></h:commandButton> 
                                        <h:commandButton value="Eliminar" onclick="return confirm('¿Desea Eliminar el Registro?')"  action="#{controllerDeUsuarios.EliminarUsuarios(user)}"/>                                    
                                    </h:form>
                                </td>
                            </tr>
                        </ui:repeat>
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Modal para agregar profesional -->
        <div id="modal" class="modal" style="display:none;">
            <h:form id="modalForm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Editar y/o Agregar  Profesional</h2>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>

                    <div class="form-group">
                        <label for="nombre">Nombre Completo:</label>
                        <h:inputText id="nombre" value="#{controllerDeUsuarios.user.nombres}" required="true" />
                    </div>
                    <div class="form-group">
                        <label for="primerA">Primer Apellido</label>
                        <h:inputText id="primerA" value="#{controllerDeUsuarios.user.primerApellido}" required="true" />
                    </div>
                    <div class="form-group">
                        <label for="SegundoA">Segundo Apellido</label>
                        <h:inputText id="segundoA" value="#{controllerDeUsuarios.user.segundoApellido}" required="true" />
                    </div>

                    <div class="form-group">
                        <label for="especialidad">Especialidad:</label>
                        <h:selectOneMenu id="especialidad" value="#{controllerDeUsuarios.esp.id}">
                            <f:selectItem itemLabel="Seleccione una especialidad" itemValue="" />
                            <f:selectItems value="#{controllerDeUsuarios.listarEspecialidades()}" />

                        </h:selectOneMenu>
                    </div>

                    <div class="form-group">
                        <label for="rol">Rol:</label>
                        <h:selectOneMenu id="rol" value="#{controllerDeUsuarios.rol.id}">
                            <f:selectItem itemLabel="Seleccione un rol" itemValue="" />
                            <f:selectItems value="#{controllerDeUsuarios.listarRoles()}" />

                        </h:selectOneMenu>
                    </div>

                    <div class="form-group">
                        <label for="usuario">Nombre deUsuario:</label>
                        <h:inputText id="usuario" value="#{controllerDeUsuarios.user.nombreUsuario}" required="true" />
                    </div>

                    <div class="form-group">
                        <label for="edad">Edad:</label>
                        <h:inputText id="edad" value="#{controllerDeUsuarios.user.edad}" required="true" />
                    </div>
                    <div class="form-group">
                        <label for="tipoDocumento">Tipo de Documento:</label>
                        <h:selectOneMenu id="tipoDocumento" value="#{controllerDeUsuarios.tipod.id}">
                            <f:selectItem itemLabel="Seleccione un tipo de documento" itemValue="" />
                            <f:selectItems value="#{controllerDeUsuarios.listarTipodeDocu()}" />

                        </h:selectOneMenu>
                    </div>

                    <div class="form-group">
                        <label for="numeroDocumento">Número Documento:</label>
                        <h:inputText id="numeroDocumento" value="#{controllerDeUsuarios.user.numeroDocumento}" required="true" />
                    </div>
                    <div class="form-group">
                        <label for="email">Correo Electrónico:</label>
                        <h:inputText id="email" value="#{controllerDeUsuarios.user.correoElectronico}" required="true" />
                    </div>

                    <div class="form-group">
                        <label for="contraseña">Contraseña:</label>
                        <div class="password-wrapper">
                            <h:inputSecret id="contraseña" value="#{controllerDeUsuarios.user.contraseña}" required="true" style="width: 100%;" />
                            <span class="toggle-password" onclick="togglePassword()">
                                <i id="iconoOjo" class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label   style="display: none;" for="fecha">Fecha de Registro</label>
                        <h:inputText style="display: none;" id="fecha" value="#{controllerDeUsuarios.user.fechaRegistro}" required="true" disabled="true" />
                    </div>
                    <h:messages globalOnly="true" style="color: red" />

                    <div class="modal-actions">
                        <h:commandButton value="Cancelar"
                                         action="#{controllerDeUsuarios.cancelar()}"
                                         onclick="closeModal()"
                                         immediate="true"
                                         styleClass="btns" />
                        <h:commandButton value="Editar" action="#{controllerDeUsuarios.actualizarUsuario()}" onclick="return confirm('¿Esta Seguro de  Editar este Usuario?')"  rendered="#{controllerDeUsuarios.user.numeroDocumento != null}" class="btn btn-primary" />

                        <h:commandButton value="Guardar" action="#{controllerDeUsuarios.crearUsuarios()}" rendered="#{controllerDeUsuarios.user.numeroDocumento == null}" styleClass="btn btn-primary" />
                    </div>
                </div>
            </h:form>
        </div>

        <!-- Notificación -->
        <div id="notification" class="notification"></div>

        <!-- Modo desarrollador -->
        <div class="dev-mode">
            Modo Desarrollador
        </div>


        <script>
            let tablaProfesionales;

            $(document).ready(function () {
                tablaProfesionales = $('.jsf-data-table').DataTable({
                    dom: 'Bfrtip',
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
                    },
                    pageLength: 50,
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });
            });

            // ✅ Esta función se llama al hacer clic en el botón "Buscar"
            function buscarProfesionales() {
                const valor = document.getElementById("search-input").value;
                tablaProfesionales.search(valor).draw(); // Aplica el filtro en la tabla

                document.getElementById("search-input").addEventListener("keyup", function () {
                    const valor = this.value;
                    tablaProfesionales.search(valor).draw();
                });
            }
        </script>
        <script>

            function openModal() {
                document.getElementById('modal').style.display = 'block';
                modal.style.display = 'block';
                const content = modal.querySelector('.modal-content');
                if (content)
                    content.scrollTop = 0;
            }

            function abrirModalSiCompletado(data) {
                if (data.status === 'success') {
                    openModal(); // Tu función ya existente para mostrar el modal
                }
            }

            // Cerrar modal
            function closeModal() {
                document.getElementById('modal').style.display = 'none';
                const form = document.getElementById('modalForm');
                if (form) {
                    form.reset();
                }
            }

            function togglePassword() {
                const input = document.getElementById("modalForm:contraseña");
                const icon = document.getElementById("iconoOjo");
                if (input) {
                    if (input.type === "password") {
                        input.type = "text";
                        icon.classList.remove("fa-eye");
                        icon.classList.add("fa-eye-slash");
                    } else {
                        input.type = "password";
                        icon.classList.remove("fa-eye-slash");
                        icon.classList.add("fa-eye");
                    }
                }
            }
        </script>

    </body>
</html>